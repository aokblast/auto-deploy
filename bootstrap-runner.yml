- hosts: all
  tasks:
  - name: Include OS-specific vars
    include_vars:
      file: "vars/{{ ansible_system | lower }}.yml"

  - name: Install killall
    ansible.builtin.package:
      name:
        - psmisc
    become: true
    when:
      - ansible_pkg_mgr == "apt"

  - name: Install 1Password Cli for FreeBSD
    ansible.builtin.package:
      name:
        - 1password-client2
    become: true
    when:
      - ansible_pkg_mgr == "pkg"

  - name: Install 1Password Cli for Debian based
    ansible.builtin.shell: |
      curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
      gpg --yes --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg && \
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
      tee /etc/apt/sources.list.d/1password.list && \
      mkdir -p /etc/debsig/policies/AC2D62742012EA22/ && \
      curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol | \
      tee /etc/debsig/policies/AC2D62742012EA22/1password.pol && \
      mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22 && \
      curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
      gpg --yes --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg && \
      apt update && apt install 1password-cli
    become: true
    when:
      - ansible_pkg_mgr == "apt"

  # chezmoi is unavailable on apt-based distro, we download the pre-build binary manually
  - name: Install chezmoi
    ansible.builtin.shell: |
      sh -c "$(curl -fsLS get.chezmoi.io)"
    args:
      creates: "./bin/chezmoi"

  - name: Temporarily add deploy key
    ansible.builtin.shell:
      cmd: |
        ssh-agent -s > ~/.ssh-agent &&
        . ~/.ssh-agent &&
        mkdir -p ~/.ssh &&
        ssh-keyscan github.com >> ~/.ssh/known_hosts &&
        echo "$DOTFILE_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    environment:
      DOTFILE_PRIVATE_KEY: "{{ lookup('env', 'DOTFILE_PRIVATE_KEY') }}"

  - name: Download and apply dotfiles
    ansible.builtin.shell:
      cmd: |
        . ~/.ssh-agent &&
        ./bin/chezmoi init git@github.com:aokblast/dotfiles.git &&
        ./bin/chezmoi apply ~/.ssh &&
        rm -rf ~/.local/share/chezmoi

  - name: Delete ssh-key and kill ssh-agent
    ansible.builtin.shell:
      cmd: |
        . ~/.ssh-agent &&
        ssh-add -D &&
        killall -q ssh-agent &&
        rm ~/.ssh-agent

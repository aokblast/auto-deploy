- hosts: all
  tasks:
  - name: Include OS-specific vars
    include_vars:
      file: "vars/{{ ansible_system | lower }}.yml"

  - name: Install killall
    ansible.builtin.package:
      name:
        - psmisc
    become: true
    when:
      - ansible_pkg_mgr == "apt"

  # chezmoi is unavailable on apt-based distro, we download the pre-build binary manually
  - name: Install chezmoi
    ansible.builtin.shell: |
      sh -c "$(curl -fsLS get.chezmoi.io)"
    args:
      creates: "./bin/chezmoi"

  - name: Temporarily add deploy key
    ansible.builtin.shell:
      cmd: |
        ssh-agent -s > ~/.ssh-agent &&
        . ~/.ssh-agent &&
        ssh-keyscan github.com >> ~/.ssh/known_hosts &&
        echo "$DOTFILE_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    environment:
      DOTFILE_PRIVATE_KEY: "{{ lookup('env', 'DOTFILE_PRIVATE_KEY') }}"

  - name: Download and apply dotfiles
    ansible.builtin.shell:
      cmd: |
        . ~/.ssh-agent &&
        ./bin/chezmoi init git@github.com:aokblast/dotfiles.git &&
        ./bin/chezmoi apply ~/.ssh &&
        rm -rf ~/.local/share/chezmoi

  - name: Delete ssh-key and kill ssh-agent
    ansible.builtin.shell:
      cmd: |
        . ~/.ssh-agent &&
        ssh-add -D &&
        killall -q ssh-agent &&
        rm ~/.ssh-agent
